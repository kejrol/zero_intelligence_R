---
title: "Agent based economics z użyciem R i NetLogo. Przykład Zero Intelligence Trading."
author: "Karol Ciulkin"
date: "28 czerwca 2016"
output: html_document
---

Niniejszy dokument stanowi przykład analizy modelu wieloagentowego. Aby samodzielnie wygenerować taki plik konieczne jest zainstalowanie NetLogo (najlepiej w wersji 5.3.1) oraz następujących pakietów: `RNetLogo`, `ggplot2` oraz `data.table`.


Pierwszy z pakietów służy do komunikacji pomiędzy R a NetLogo. Używa przy tym Javy i pakietu `rJava`. Aktualność tychże zostanie prawdopodobnie zweryfikowana przy instalacji powyższego pakietu, ale warto o tym pamiętać.
Na początku należy wczytać do środowiska pracy wspomniane pakiety:


```{r, message = F}
library(RNetLogo)
library(ggplot2)
library(data.table)
```

W kolejnym kroku inicjalizuje się sesję NetLogo Aby poniższy kod działał prawdiłowo, zmienna`path` powinna wskazywać ścieżkę do folderu zawierającego plik wykonywalny NetLogo. Zmienna `modelPath` opisuje z kolei ścieżkę względną z tego miejsca do modelu (od folderu zawierającego plik wykonywalny netlogo). Użyty w niniejszym raporcie model pochodzi z `https://github.com/memcbride/ZITrading`. Jest to aplikacja modelu Gode, Sunder(1993) (bibliografia znajduje na końcu niniejszego tekstu). Zmodyfikowano jedynie ograniczenia co do wielkości parametrów modelu (podniesione maksymalne liczby agentów).

```{r, echo = F,message = F}
path <- "/home/kejrol/netlogo/app"
modelPath <- "models/Downloaded/ZITrading/ZITrading.nlogo"
```
```{r, message = F}
oldPath <- getwd()
NLStart(nl.path = path, gui = F) # uwaga, w tym miejscu zmieniany jest katalog roboczy

NLQuit(all = T)
setwd(oldPath)
```



```{r, echo = FALSE, message = F}
oldw <- getOption("warn")
options(warn = -1)

library(data.table)
library(reshape2)

options(warn = oldw)

installAndLoadPackages <- function(packageList)
{
  for (i in packageList) {
    if (!(i %in% installed.packages()[,1])) { # check if package was installed
      print(paste0('Installing package ', i, '...'))
      install.packages(i)
    } else print(paste0('Package ', i, ' already installed.'))
  }
  lapply(packageList, require, character.only = TRUE)
}

runSimulation <- function(conditions = "ticks < maxNumberOfTrades",
                          report = c("ticks", "efficiency",
                                     "transactionPrice", "actualSurplus"))
{
  NLDoCommand(1, "setup")
  NLDoCommandWhile(condition = conditions,
                   command = "go")
  
  temp <- data.frame(NLReport(reporter = report))
  colnames(temp) <- report
  
  return(temp)
}

parametrizeAndRun <- function(constrained = T, nOfBuyers = 70, nOfSellers = 60,
                        maxBuyVal = 170, maxSellCost = 180,
                        conditions = "ticks < maxNumberOfTrades",
                        report = c("ticks", "efficiency",
                                   "transactionPrice", "actualSurplus"))
{
  if (constrained) {constr <- "true"} else {constr <- "false"}
  NLCommand(paste0("set constrained ", constr))
  
  count <- 0
  for (nBuyers in nOfBuyers)
  {
    # nBuyers <- 133
    NLCommand(paste0("set numberOfBuyers ", nBuyers))
    
    for (nSellers in nOfSellers)
    {
      # nSellers <- 143
      NLCommand(paste0("set numberOfSellers ", nSellers))
      
      for (maxBVal in maxBuyVal)
      {
        # maxBVal <- 101
        NLCommand(paste0("set maxBuyerValue ", maxBVal))
        
        for (maxSCost in maxSellCost)
        {
          # maxSCost <- 30
          NLCommand(paste0("set maxSellerCost ", maxSCost))
          nBuyersV <- c(nBuyersV, nBuyers)
          nSellersV <- c(nSellersV, nSellers)
          maxSCostV <- c(maxSCostV, maxSCost)
          maxBValV <- c(maxBValV, maxBVal)
          
          count <- count + 1
          print(paste("Iteracja:", count, "| Parametry:", nBuyers, nSellers, maxBVal, maxSCost))
          
          df <- rbind(df, runSimulation(conditions,
                                        report))
        }
      }
    }
  }
  return(df)
}

```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Bibliografia
(@) Gode, D. K., & Sunder, S. (1993). Allocative efficiency of markets with zero-intelligence traders: Market as a partial substitute for individual rationality. Journal of political economy, 119-137.
(@) https://github.com/memcbride/ZITrading